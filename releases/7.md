# Release 7: Interpreter - Variables and Assignment

> Follow CLAUDE.md - do not implement until user approves complete release plan.

## Code Quality Analysis (from Release 6)

**Current codebase:** 4,512 lines across 19 files (12 src, 7 tests, 1 css, 1 html)

### Source Files
| File | Lines | Status |
|------|-------|--------|
| scanner.js | 384 | OK - state machine is inherently complex |
| lexer.js | 370 | OK |
| parser.js | 334 | OK - clean recursive descent |
| main.js | 284 | OK - reduced from 432 by extracting renderers |
| ast-renderer.js | 231 | OK |
| interpreter.js | 216 | OK - includes Environment class |
| reference.js | 138 | OK - updated with variable docs |
| parser-renderer.js | 136 | NEW - extracted from main.js |
| visualizer.js | 101 | OK |
| output-renderer.js | 63 | NEW - extracted from main.js |
| examples.js | 59 | OK |
| utils.js | 19 | OK |

### Test Files
| File | Lines | Tests | Status |
|------|-------|-------|--------|
| lexer-viz.spec.js | 346 | 23 | OK |
| parser.spec.js | 242 | 20 | OK |
| interpreter.spec.js | 219 | 22 | OK |
| ast.spec.js | 203 | 14 | OK |
| ui.spec.js | 166 | 15 | OK |
| lexer.spec.js | 150 | 13 | OK |
| variables.spec.js | 131 | 18 | NEW |

**Total: 125 tests passing**

### Code Quality Wins
- **main.js refactored:** Split from 432 to 284 lines by extracting:
  - `parser-renderer.js` - Parser tab rendering (scan state, token list)
  - `output-renderer.js` - Output tab rendering (errors, output values)
- Each tab now has its own renderer (AST, Parser, Output)
- Environment class cleanly encapsulates variable storage

### Monitoring
- CSS file at 656 lines - consider splitting if it grows further
- Check main.js size each release

---

## Goal

Add **variable support** to the interpreter! This release enables:
- Declaring variables with `let x = value`
- Using variables in expressions `x + 1`
- Reassigning variables `x = newValue`
- **Dynamic typing** - variables can change type after declaration

Connor can now write programs that store and manipulate data!

## Features

### Variable Declaration

```
let name = "Connor"
let count = 42
let isReady = true
```

Variables are declared with `let` and must be initialized.

### Variable Usage

Variables can be used in any expression:

```
let x = 10
let y = 20
print x + y    // Output: 30
```

### Variable Assignment

Variables can be reassigned:

```
let count = 1
count = count + 1
print count    // Output: 2
```

### Dynamic Typing

Variables can change type after declaration:

```
let value = 42       // number
value = "hello"      // now a string
print value          // Output: hello
```

This is similar to JavaScript and Python - variables hold values of any type.

### Scope Rules (Simple for now)

For this release, all variables are **global**:
- Variables are visible everywhere after declaration
- No block scope yet (that comes with if/else and functions)

## Implementation

### New Files

#### src/parser-renderer.js
Renders the Parser tab content:
- `renderScanState(scanResult, tokens, switchTab)` - step-through scanner visualization
- `renderTokens(tokens, source)` - static token list with stats
- `clear()` - clear the container

#### src/output-renderer.js
Renders the Output tab content:
- `renderErrors(lexErrors, parseErrors, runtimeErrors)` - error display
- `renderOutput(values)` - program output
- `renderMessage(message)` - simple messages like "Hello, Connor!"
- `clear()` - clear the container

### Environment Class (in interpreter.js)

```javascript
class Environment {
  constructor() {
    this.values = new Map();
  }

  define(name, value) {
    this.values.set(name, value);
  }

  get(name) {
    if (this.values.has(name)) {
      return this.values.get(name);
    }
    throw new RuntimeError(`Undefined variable: ${name}`);
  }

  assign(name, value) {
    if (this.values.has(name)) {
      this.values.set(name, value);
      return;
    }
    throw new RuntimeError(`Undefined variable: ${name}`);
  }
}
```

### Interpreter Updates

```javascript
case 'LetStatement': {
  const value = await this.evaluate(node.value);
  this.environment.define(node.name, value);
  result = value;
  break;
}

case 'AssignStatement': {
  const value = await this.evaluate(node.value);
  this.environment.assign(node.name, value);
  result = value;
  break;
}

case 'Identifier':
  result = this.environment.get(node.name);
  break;
```

### Reference Panel Updates

Added "Variables" section documenting:
- Declaration syntax
- Assignment syntax
- Dynamic typing behavior

## File Changes

```
src/
  parser-renderer.js   # NEW - Parser tab rendering
  output-renderer.js   # NEW - Output tab rendering
  interpreter.js       # Add Environment class, variable support
  main.js              # Refactored to use renderers
  ast-renderer.js      # Added clear() method
  reference.js         # Added variables documentation
index.html             # Include new script files
tests/
  variables.spec.js    # NEW - 18 variable tests
```

## Playwright Tests (variables.spec.js)

### Variable Declaration (5 tests)
1. interpreter declares and uses variable
2. interpreter declares string variable
3. interpreter declares boolean variable
4. interpreter uses variable in expression
5. interpreter uses variable in complex expression

### Variable Assignment (4 tests)
6. interpreter assigns to variable
7. interpreter assigns expression to variable
8. interpreter increments variable
9. interpreter assigns string to variable

### Multiple Variables (3 tests)
10. interpreter handles multiple variables
11. interpreter uses variables in comparison
12. interpreter concatenates string variables

### Dynamic Typing (3 tests)
13. variable can change from number to string
14. variable can change from string to number
15. variable can change from boolean to string

### Negative Tests (3 tests)
16. undefined variable shows error
17. assignment to undefined variable shows error
18. cannot use variable before declaration

## Deliverables

- [x] Create src/parser-renderer.js (extracted from main.js)
- [x] Create src/output-renderer.js (extracted from main.js)
- [x] Update main.js to use new renderers
- [x] Add Environment class to interpreter.js
- [x] Update Interpreter.execute() for LetStatement
- [x] Update Interpreter.execute() for AssignStatement
- [x] Update Interpreter.evaluate() for Identifier
- [x] Update reference.js with variable documentation
- [x] Update index.html with new script files
- [x] Create tests/variables.spec.js with 18 tests
- [x] All tests passing (125 total: 107 existing + 18 new)

## Notes for Future Releases

> **Stack Visualizer Reminder:** When implementing the stack visualizer (Release 8), remember to show variables currently in scope. The Environment class already has a `getAll()` method that returns all variable bindings for this purpose.

> **AST Type Representation:** In a future release, represent variable types more explicitly in the AST visualization. This could show type information (number, string, boolean) alongside values to help Connor understand the type system.

## Status

**COMPLETE**
