# Release 9: Code Highlighting During Execution

> Follow CLAUDE.md - do not implement until user approves complete release plan.

## Code Quality Analysis

**Current codebase:** 5,254 lines across 21 files (13 src, 8 tests, 3 css, 1 html)
**Tests:** 140 passing

### Issues to Address

| Priority | Issue | Action |
|----------|-------|--------|
| **MONITOR** | interpreter.css at 512 lines | Consider splitting if grows past 600 |
| **MONITOR** | scanner.js at 384 lines | OK - state machine is inherently complex |

No critical issues. Codebase is healthy.

---

## Goal

**Highlight the currently executing code** in the Code pane, synchronized with AST node highlighting.

When the interpreter enters an AST node during animated execution, the corresponding source code should pulse/highlight - showing Connor exactly which code is running.

## Current State

- AST nodes highlight during execution (Release 7)
- But the Code pane shows static source code
- No visual connection between code and what's executing

## Feature: Code Highlighting

### Visual Design

```
┌─────────────────┐  ┌─────────────────────────┐  ┌─────────────────┐
│      Code       │  │       Interpreter       │  │     Output      │
├─────────────────┤  ├─────────────────────────┤  ├─────────────────┤
│ let x = 42      │  │         [AST]           │  │                 │
│ ████████████    │  │    ┌─────────────┐      │  │                 │
│ print x + 1     │  │    │ PrintStmt ● │      │  │                 │
│                 │  │    └─────────────┘      │  │                 │
└─────────────────┘  └─────────────────────────┘  └─────────────────┘
     ▲                        ▲
     │                        │
     └────── synchronized ────┘
```

When `PrintStatement` node is executing:
- AST node pulses (existing behavior)
- Code line `print x + 1` also pulses with matching animation

### Implementation Approach

**Key insight:** AST nodes need source location info to highlight corresponding code.

#### Step 1: Add Spans to AST Nodes

Tokens already have location info:
```javascript
// Token structure (from lexer)
{
  type: 'KEYWORD',
  value: 'let',
  line: 1,
  column: 1,
  raw: 'let',
  // Lexer also tracks: start, end positions
}
```

Add spans when creating AST nodes in parser:
```javascript
// Before (current)
return {
  type: 'LetStatement',
  name: nameToken.value,
  value: value
};

// After (with span)
return {
  type: 'LetStatement',
  name: nameToken.value,
  value: value,
  span: { start: startToken.start, end: this.previousToken().end }
};
```

#### Step 2: Track Token Positions

Update lexer to include `start` and `end` on every token:
```javascript
makeToken(type, value, raw) {
  return {
    type,
    value,
    line: this.tokenLine,
    column: this.tokenColumn,
    raw,
    start: this.tokenStart,  // Add this
    end: this.pos            // Add this
  };
}
```

#### Step 3: Update Parser to Build Spans

Track statement start/end positions:
```javascript
parseLetStatement() {
  const startPos = this.previous().start;  // 'let' keyword
  const nameToken = this.consume('IDENTIFIER', null, "...");
  this.consume('OPERATOR', '=', "...");
  const value = this.parseExpression();
  const endPos = this.previous().end;      // last token of expression

  return {
    type: 'LetStatement',
    name: nameToken.value,
    value: value,
    span: { start: startPos, end: endPos }
  };
}
```

#### Step 4: Highlight Code on Node Enter

Update main.js to highlight code when entering a node:
```javascript
const interpreter = new Interpreter({
  stepDelay: 5000,
  onNodeEnter: (node) => {
    astRenderer.highlightNode(node);
    if (node.span) {
      visualizer.highlight(node.span);  // Already exists!
    }
  },
  onNodeExit: (node) => {
    // Keep highlight until next node
  }
});
```

The `visualizer.highlight(span)` method already exists from Release 6!

### Visual Styling

Reuse the pulse animation from AST highlighting:
```css
.code-display .code-executing {
  animation: code-pulse 0.8s ease-in-out infinite;
  background: rgba(74, 122, 255, 0.3);
  border-radius: 2px;
}

@keyframes code-pulse {
  0%, 100% { background: rgba(74, 122, 255, 0.3); }
  50% { background: rgba(74, 122, 255, 0.5); }
}
```

## File Changes

```
src/
  lexer.js           # Add start/end to all tokens
  parser.js          # Add span to all AST nodes
  visualizer.js      # Add highlightExecuting() method
  main.js            # Connect onNodeEnter to visualizer
styles/
  interpreter.css    # Add .code-executing styles
tests/
  code-highlight.spec.js  # NEW - code highlighting tests
```

## Implementation Details

### Lexer Changes

Add `start` and `end` to the token creation:

```javascript
// In makeToken() and all token-creating methods
return {
  type,
  value,
  line: this.tokenLine,
  column: this.tokenColumn,
  raw,
  start: this.tokenStart,
  end: this.pos
};
```

### Parser Changes

Add helper to get span from current position:
```javascript
// Track the previous token for end positions
previous() {
  return this.tokens[this.pos - 1];
}

// Helper to create span from start to current position
makeSpan(startPos) {
  const prev = this.previous();
  return { start: startPos, end: prev ? prev.end : startPos };
}
```

Add spans to each statement type:
- LetStatement: from 'let' to end of value expression
- AssignStatement: from identifier to end of value expression
- PrintStatement: from 'print' to end of expression
- IfStatement: from 'if' to closing '}'
- WhileStatement: from 'while' to closing '}'
- Block: from '{' to '}'
- ExpressionStatement: span of the expression
- BinaryExpression: from left operand start to right operand end
- Literals: span of the token
- Identifier: span of the token

### Visualizer Changes

Add a new highlight mode for execution:
```javascript
// Highlight code span during execution (with pulse animation)
highlightExecuting(span) {
  if (!this.source || !span) return;

  const before = this.escapeHtml(this.source.substring(0, span.start));
  const current = this.escapeHtml(this.source.substring(span.start, span.end));
  const after = this.escapeHtml(this.source.substring(span.end));

  this.container.innerHTML =
    `<span class="code-done">${before}</span>` +
    `<span class="code-executing">${current}</span>` +
    `<span class="code-pending">${after}</span>`;
}

clearExecutingHighlight() {
  // Show source without highlighting
  this.showInitial();
}
```

## Playwright Tests

### Code Highlight Tests (new file: code-highlight.spec.js)

1. **"code highlights during animated run"**
   - Run animated: `let x = 42`
   - Verify `.code-executing` class appears on code

2. **"code highlight matches AST highlight"**
   - Run animated: `let x = 42\nprint x`
   - When AST shows LetStatement highlighted, code shows `let x = 42` highlighted
   - When AST shows PrintStatement highlighted, code shows `print x` highlighted

3. **"code highlight moves through statements"**
   - Run animated with multiple statements
   - Verify highlight moves from first to last statement

4. **"code highlight cleared after execution"**
   - Run animated to completion
   - Verify no `.code-executing` class remains

5. **"code highlight works with if statement"**
   - Run animated: `if (true) { print 1 }`
   - Verify if statement and inner print both highlight at appropriate times

6. **"code highlight works with while loop"**
   - Run animated: `let i = 0\nwhile (i < 2) { i = i + 1 }`
   - Verify while condition highlights each iteration

7. **"code highlight spans correct characters"**
   - Run animated: `let longVariableName = 12345`
   - Verify the entire statement is highlighted, not just a portion

8. **"no code highlight during Run Fast"**
   - Click Run Fast
   - Verify no `.code-executing` class (too fast to see)

### Existing Test Updates

Update any tests that check code display content to account for new span-based rendering.

## Deliverables

### Parser Enhancement
- [ ] Add `start`, `end` to all tokens in lexer
- [ ] Add helper methods: `previous()`, `makeSpan()`
- [ ] Add `span` property to all AST node types

### Visualizer Enhancement
- [ ] Add `highlightExecuting(span)` method
- [ ] Add `clearExecutingHighlight()` method

### Integration
- [ ] Update main.js `onNodeEnter` to call visualizer
- [ ] Add CSS for `.code-executing` animation

### Tests
- [ ] Create tests/code-highlight.spec.js with 8 tests
- [ ] All tests passing (148+ total)

## Notes

**Why this matters for learning:**
- Shows the direct connection between source code and execution
- Connor can see exactly which code is running
- Reinforces that the interpreter walks the AST, which maps back to code

**Future enhancement:**
- Could show expression evaluation within a line (e.g., highlight `x + 1` then `43`)
- Could show variable values inline during execution

## Status

**DRAFT** - Awaiting user approval
