# Release 21: Code Quality Cleanup

## Status: PLANNING

## Overview

Address code quality issues identified in Release 20 analysis.

---

## Code Quality Summary

**Strengths:**
- Clean separation of concerns (Lexer → Parser → Interpreter)
- Consistent patterns across renderers
- Good naming conventions
- No circular dependencies
- Custom error classes with context

**Issues Found:**

| Category | Count | Notable Items |
|----------|-------|---------------|
| Dead code | 2 | `reference.js` entirely unused, `renderLegacy()` never called |
| Potential bugs | 3 | Infinite loop risk in lexer, null guard missing in parser, event listener leak |
| Code smells | 4 | Large files (interpreter 617 LOC, parser 596 LOC), token mutation, duplicate `peekNext()` |
| Inconsistencies | 2 | Mixed module formats, inconsistent error returns |

The codebase is in good shape overall. The most actionable items for a future release would be:
1. Delete `reference.js` (unused)
2. Fix the infinite recursion risk in `lexer.js:172-179`
3. Remove the unused `renderLegacy()` method

---

## Proposed Tasks

### Priority 1: Dead Code Removal

- [ ] Delete `src/reference.js` - entire file is unused
- [ ] Remove `renderLegacy()` from `memory-renderer.js:128-152`

### Priority 2: Bug Fixes

- [ ] Fix infinite loop risk in `lexer.js:172-179` - invalid char error leads to recursive `nextToken()` call
- [ ] Add null guard in `parser.js:86-88` - `getTitle()` doesn't check for null token
- [ ] Fix event listener leak in `output-renderer.js:140-154` - `keydown` listener may not be removed on error paths

### Priority 3: Code Smells (Deferred)

These are lower priority and can be addressed later:

- `interpreter.js` - 617 lines, consider splitting
- `parser.js` - 596 lines, consider splitting
- `scanner.js:276-277` - mutates token value after adding to array
- `lexer.js:223-227, 371-374` - `peekNext()` defined twice

### Priority 4: Inconsistencies (Deferred)

- `reference.js` - has CommonJS export alongside ES modules (will be deleted anyway)
- `lexer.js` - `readString()` returns null on error vs token object
