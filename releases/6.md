# Release 6: Interpreter - Numbers and Arithmetic

> Follow CLAUDE.md - do not implement until user approves complete release plan.

## Code Quality Analysis (from Release 5)

**Current codebase:** 3,660 lines across 15 files (8 src, 5 tests, 1 css, 1 html)

### Source Files
| File | Lines | Status |
|------|-------|--------|
| scanner.js | 398 | OK - state machine is inherently complex |
| lexer.js | 384 | OK |
| parser.js | 334 | OK - clean recursive descent |
| main.js | 316 | OK - previous long functions have been refactored |
| ast-renderer.js | 198 | OK - clean recursive rendering |
| reference.js | 117 | OK |
| visualizer.js | 101 | OK |
| examples.js | 59 | OK |

### Test Files
| File | Lines | Tests | Status |
|------|-------|-------|--------|
| lexer-viz.spec.js | 346 | 23 | OK |
| parser.spec.js | 242 | 20 | OK |
| ast.spec.js | 203 | 14 | OK |
| lexer.spec.js | 150 | 13 | OK |
| ui.spec.js | 133 | 13 | OK |

**Total: 83 tests passing**

### Issues to Address

1. **Duplicate code:** `isDigit()`, `isAlpha()`, `isAlphaNumeric()` exist in both lexer.js and scanner.js
   - **Recommendation:** Extract to shared `src/utils.js` in this release

2. **CSS file growing:** 621 lines
   - **Recommendation:** Consider splitting by feature if it grows much more (monitor)

### Resolved Issues
- Long functions in main.js have been refactored through tabbed UI implementation

---

## Goal

Begin the interpreter phase! This release adds the ability to actually **execute** code. We start simple:
- Evaluate numeric expressions: `42`, `1 + 2`, `3 * 4 + 5`
- Show the result in the Output tab

This is the first step toward a fully working interpreter. Connor can now write math expressions and see them evaluated!

## Features

### Expression Evaluation

The interpreter will evaluate expressions and display the result:

```
Input: 2 + 3 * 4
Output: 14
```

```
Input: (2 + 3) * 4
Output: 20
```

### Supported Operations

| Operator | Description | Example | Result |
|----------|-------------|---------|--------|
| `+` | Addition | `2 + 3` | `5` |
| `-` | Subtraction | `5 - 2` | `3` |
| `*` | Multiplication | `3 * 4` | `12` |
| `/` | Division | `10 / 2` | `5` |
| `()` | Grouping | `(2 + 3) * 4` | `20` |

### Error Handling

- Division by zero: `"Error: Division by zero"`
- Non-numeric operands (for now): `"Error: Cannot perform arithmetic on non-numeric value"`

### UI Integration

The Output tab now shows actual execution results:

**Before (Release 5):**
```
(no output yet - execution coming in future release)
```

**After (Release 6):**
```
14
```

For expression statements that evaluate to a value, show the result. For statements without output (like future `let` statements), show nothing.

## Implementation

### Interpreter Class

```javascript
// src/interpreter.js
class Interpreter {
  constructor() {
    // No environment yet - that's Release 7
  }

  // Main entry point - evaluate a program
  interpret(ast) {
    const results = [];
    for (const statement of ast.statements) {
      const result = this.execute(statement);
      if (result !== undefined && result !== null) {
        results.push(result);
      }
    }
    return {
      output: results,
      errors: []
    };
  }

  // Execute a statement
  execute(node) {
    switch (node.type) {
      case 'ExpressionStatement':
        return this.evaluate(node.expression);
      case 'PrintStatement':
        // Print evaluates and returns the value for output
        return this.evaluate(node.value);
      // Other statements will be added in future releases
      default:
        return null;
    }
  }

  // Evaluate an expression
  evaluate(node) {
    switch (node.type) {
      case 'NumberLiteral':
        return node.value;

      case 'StringLiteral':
        return node.value;

      case 'BooleanLiteral':
        return node.value;

      case 'BinaryExpression':
        return this.evaluateBinary(node);

      case 'Identifier':
        // Variables come in Release 7
        throw new RuntimeError(`Undefined variable: ${node.name}`);

      default:
        throw new RuntimeError(`Unknown expression type: ${node.type}`);
    }
  }

  // Evaluate binary expression
  evaluateBinary(node) {
    const left = this.evaluate(node.left);
    const right = this.evaluate(node.right);

    // For now, require numeric operands for arithmetic
    if (typeof left !== 'number' || typeof right !== 'number') {
      // Allow string concatenation with +
      if (node.operator === '+' && (typeof left === 'string' || typeof right === 'string')) {
        return String(left) + String(right);
      }
      throw new RuntimeError(`Cannot perform '${node.operator}' on non-numeric values`);
    }

    switch (node.operator) {
      case '+': return left + right;
      case '-': return left - right;
      case '*': return left * right;
      case '/':
        if (right === 0) {
          throw new RuntimeError('Division by zero');
        }
        return left / right;
      case '<': return left < right;
      case '>': return left > right;
      case '<=': return left <= right;
      case '>=': return left >= right;
      case '==': return left === right;
      case '!=': return left !== right;
      default:
        throw new RuntimeError(`Unknown operator: ${node.operator}`);
    }
  }
}

// Runtime error class
class RuntimeError extends Error {
  constructor(message) {
    super(message);
    this.name = 'RuntimeError';
  }
}
```

### Integration with main.js

Update `runAll()` to use the interpreter:

```javascript
// In runAll():
// ... after parsing ...

// Interpret the AST
const interpreter = new Interpreter();
let interpreterResult;
try {
  interpreterResult = interpreter.interpret(parseResult.ast);
} catch (error) {
  interpreterResult = {
    output: [],
    errors: [{ message: error.message }]
  };
}

// Build output text
let outputText = '';

// Show lexer errors
if (lexResult.errors.length > 0) {
  outputText += 'Lexer Errors:\n';
  for (const error of lexResult.errors) {
    outputText += `  Line ${error.line}, Column ${error.column}: ${error.message}\n`;
  }
  outputText += '\n';
}

// Show parser errors
if (parseResult.errors.length > 0) {
  outputText += 'Parser Errors:\n';
  for (const error of parseResult.errors) {
    outputText += `  Line ${error.line}, Column ${error.column}: ${error.message}\n`;
  }
  outputText += '\n';
}

// Show runtime errors
if (interpreterResult.errors.length > 0) {
  outputText += 'Runtime Errors:\n';
  for (const error of interpreterResult.errors) {
    outputText += `  ${error.message}\n`;
  }
  outputText += '\n';
}

// Show output (actual execution results!)
if (interpreterResult.output.length > 0) {
  for (const value of interpreterResult.output) {
    outputText += String(value) + '\n';
  }
}

if (!outputText) {
  outputText = '(no output)';
}

tabOutput.textContent = outputText;
```

## Refactoring: Extract Character Utils

Create `src/utils.js` to eliminate duplicate code:

```javascript
// src/utils.js - Shared utility functions

function isDigit(char) {
  return char >= '0' && char <= '9';
}

function isAlpha(char) {
  return (char >= 'a' && char <= 'z') ||
         (char >= 'A' && char <= 'Z') ||
         char === '_';
}

function isAlphaNumeric(char) {
  return isAlpha(char) || isDigit(char);
}

// Export for use in other modules
// (Using window globals since we're not using a bundler)
window.CharUtils = { isDigit, isAlpha, isAlphaNumeric };
```

Update lexer.js and scanner.js to use `CharUtils.isDigit()` etc.

## File Structure

```
src/
  utils.js         # NEW - shared character utilities
  interpreter.js   # NEW - expression evaluator
  lexer.js         # Updated - use CharUtils
  scanner.js       # Updated - use CharUtils
  parser.js        # Existing
  ast-renderer.js  # Existing
  main.js          # Updated - integrate interpreter
  visualizer.js    # Existing
  reference.js     # Existing
  examples.js      # Existing
```

## Playwright Tests

### Positive Tests

1. **"interpreter evaluates number literal"**
   - Input: `42`
   - Verify output contains `42`

2. **"interpreter evaluates addition"**
   - Input: `2 + 3`
   - Verify output contains `5`

3. **"interpreter evaluates subtraction"**
   - Input: `10 - 4`
   - Verify output contains `6`

4. **"interpreter evaluates multiplication"**
   - Input: `3 * 4`
   - Verify output contains `12`

5. **"interpreter evaluates division"**
   - Input: `20 / 4`
   - Verify output contains `5`

6. **"interpreter respects operator precedence"**
   - Input: `2 + 3 * 4`
   - Verify output contains `14` (not `20`)

7. **"interpreter respects parentheses"**
   - Input: `(2 + 3) * 4`
   - Verify output contains `20`

8. **"interpreter handles complex expressions"**
   - Input: `1 + 2 * 3 - 4 / 2`
   - Verify output contains `5`

9. **"interpreter evaluates comparison to boolean"**
   - Input: `5 > 3`
   - Verify output contains `true`

10. **"interpreter evaluates equality to boolean"**
    - Input: `5 == 5`
    - Verify output contains `true`

11. **"print statement shows output"**
    - Input: `print 42`
    - Verify output contains `42`

12. **"multiple expressions show multiple outputs"**
    - Input: `1 + 2\n3 * 4`
    - Verify output contains `3` and `12`

13. **"string concatenation works"**
    - Input: `"hello" + " " + "world"`
    - Verify output contains `hello world`

### Negative Tests

14. **"division by zero shows error"**
    - Input: `10 / 0`
    - Verify output contains `Division by zero`

15. **"undefined variable shows error"**
    - Input: `x + 1`
    - Verify output contains `Undefined variable`

16. **"arithmetic on non-numbers shows error"**
    - Input: `"hello" - 5`
    - Verify output contains error about non-numeric

## Deliverables

- [ ] Create src/utils.js with shared character utilities
- [ ] Update src/lexer.js to use CharUtils
- [ ] Update src/scanner.js to use CharUtils
- [ ] Create src/interpreter.js with Interpreter class
- [ ] Update src/main.js to integrate interpreter
- [ ] Update index.html to include new scripts
- [ ] tests/interpreter.spec.js with 16 tests
- [ ] All tests passing (99 total: 83 existing + 16 new)

## Notes for Future Releases

> **Stack Visualizer Reminder:** When implementing the stack visualizer (Release 8), remember to show variables currently in scope. This should display which variables are accessible at each point during execution.

## Status

**PENDING APPROVAL**
