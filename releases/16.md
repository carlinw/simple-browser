# Release 16: Input, Random, String Indexing, Float Literals

> Follow CLAUDE.md - do not implement until user approves complete release plan.

## Goals

Add user interaction, randomness, and float number support to enable interactive programs like Guess the Number and Blackjack.

---

## New Features

### 1. input() - Line Input

```
print "What is your name?"
let name = input()
print "Hello, " + name
```

- Waits for user to type a line and press Enter
- Returns the entered string

### 2. key() - Single Key Input

```
print "Press any key..."
let k = key()
print "You pressed: " + k
```

- Waits for a single keypress (no Enter needed)
- Returns the key as a string
- Useful for games and interactive programs

### 3. num() - String to Number Conversion

```
print "Age:"
let age = num(input())          // Convert string to number
let x = num("42")               // 42
let y = num("3.14")             // 3.14
let z = num("hello")            // Error: cannot convert
```

- Converts string to number
- Works with integers and decimals
- Throws error if string isn't a valid number

### 4. random() - Random Numbers

```
let dice = random(1, 6)      // Random integer 1-6
let coin = random(0, 1)      // 0 or 1
let percent = random(0, 100) // 0-100
```

- `random(min, max)` returns integer in range [min, max] inclusive
- Both arguments required

### 5. String Indexing

```
let s = "hello"
print s[0]       // "h"
print s[4]       // "o"
print len(s)     // 5 (already works)
```

- Access individual characters by index
- Zero-based like arrays
- Out of bounds throws error

### 6. Float Literals

```
let pi = 3.14159
let half = 0.5
print pi * 2     // 6.28318
```

- Numbers can now have decimal points
- Works with all arithmetic operations
- Both lexer and scanner updated

---

## Implementation

### Interpreter Changes

#### 1. Update validateArrayAccess for strings

```javascript
validateArrayAccess(object, index) {
  if (!Array.isArray(object) && typeof object !== 'string') {
    throw new RuntimeError('Cannot index non-array/string value');
  }
  if (typeof index !== 'number' || !Number.isInteger(index)) {
    throw new RuntimeError('Index must be an integer');
  }
  if (index < 0 || index >= object.length) {
    throw new RuntimeError(`Index ${index} out of bounds (length: ${object.length})`);
  }
}
```

#### 2. Add num() builtin

```javascript
if (funcName === 'num') {
  if (args.length !== 1) {
    throw new RuntimeError('num() requires 1 argument');
  }
  const arg = args[0];
  if (typeof arg === 'number') {
    return arg;  // Already a number
  }
  if (typeof arg !== 'string') {
    throw new RuntimeError('num() requires a string argument');
  }
  const parsed = Number(arg);
  if (isNaN(parsed)) {
    throw new RuntimeError(`Cannot convert "${arg}" to number`);
  }
  return parsed;
}
```

#### 3. Add random() builtin

In `executeCall()` or as a new BuiltinCall case:

```javascript
if (funcName === 'random') {
  if (args.length !== 2) {
    throw new RuntimeError('random() requires 2 arguments (min, max)');
  }
  const [min, max] = args;
  if (typeof min !== 'number' || typeof max !== 'number') {
    throw new RuntimeError('random() requires number arguments');
  }
  if (!Number.isInteger(min) || !Number.isInteger(max)) {
    throw new RuntimeError('random() requires integer arguments');
  }
  if (min > max) {
    throw new RuntimeError('random() min must be <= max');
  }
  return Math.floor(Math.random() * (max - min + 1)) + min;
}
```

#### 4. Add input() builtin

This requires async UI interaction:

```javascript
if (funcName === 'input') {
  if (args.length !== 0) {
    throw new RuntimeError('input() takes no arguments');
  }
  return await this.requestInput();
}
```

#### 5. Add key() builtin

```javascript
if (funcName === 'key') {
  if (args.length !== 0) {
    throw new RuntimeError('key() takes no arguments');
  }
  return await this.requestKey();
}
```

Add request methods that trigger UI:

```javascript
async requestInput() {
  if (this.onInput) {
    return await this.onInput();
  }
  throw new RuntimeError('Input not supported in this environment');
}

async requestKey() {
  if (this.onKey) {
    return await this.onKey();
  }
  throw new RuntimeError('Key input not supported in this environment');
}
```

### Parser Changes

No changes needed - `input`, `key`, `num`, `random` are handled as regular function calls that resolve to builtins at runtime.

### UI Changes (main.js)

Add input and key handlers:

```javascript
const interpreter = new Interpreter({
  // ... existing options ...
  onInput: async () => {
    return await showInputField();
  },
  onKey: async () => {
    return await waitForKeypress();
  }
});

async function showInputField() {
  return new Promise((resolve) => {
    // Show input field in output pane
    // User types and presses Enter
    // Resolve with entered text
  });
}

async function waitForKeypress() {
  return new Promise((resolve) => {
    // Listen for single keydown event
    // Resolve with key string
  });
}
```

### Reference Panel Changes

Add to builtins:

```javascript
builtins: [
  { name: 'len(x)', desc: 'length of array or string' },
  { name: 'num(x)', desc: 'convert string to number' },
  { name: 'input()', desc: 'read line of input' },
  { name: 'key()', desc: 'read single keypress' },
  { name: 'random(min, max)', desc: 'random integer in range' },
]
```

Update arrays section:

```javascript
arrays: [
  { name: 'Literal', desc: '[1, 2, 3]' },
  { name: 'Access', desc: 'arr[0]' },
  { name: 'Assignment', desc: 'arr[0] = value' },
  { name: 'Nested', desc: 'arr[0][1]' },
  { name: 'String index', desc: '"hello"[0] → "h"' },
],
```

---

## Tests

### tests/input.spec.js (NEW)

1. **"input returns entered value"**
   - Mock input to return "Alice"
   - Run: `let name = input()\nprint name`
   - Output: `Alice`

2. **"input in expression"**
   - Mock input to return "hello"
   - Run: `print "You said: " + input()`
   - Output: `You said: hello`

3. **"key returns single character"**
   - Mock key to return "a"
   - Run: `let k = key()\nprint k`
   - Output: `a`

### tests/num.spec.js (NEW)

4. **"num converts string to integer"**
   - Run: `print num("42")`
   - Output: `42`

5. **"num converts string to decimal"**
   - Run: `print num("3.14")`
   - Output: `3.14`

6. **"num passes through numbers"**
   - Run: `print num(99)`
   - Output: `99`

7. **"num with invalid string errors"**
   - Run: `print num("hello")`
   - Error: `Cannot convert`

8. **"num with input for math"**
   - Mock input to return "5"
   - Run: `let x = num(input("X: "))\nprint x + 10`
   - Output: `15`

### tests/random.spec.js (NEW)

9. **"random returns integer in range"**
    - Run: `let r = random(1, 10)\nprint r >= 1 and r <= 10`
    - Output: `true`

10. **"random(0, 0) returns 0"**
    - Run: `print random(0, 0)`
    - Output: `0`

11. **"random(5, 5) returns 5"**
    - Run: `print random(5, 5)`
    - Output: `5`

12. **"random requires two arguments"**
    - Run: `print random(5)`
    - Error: `requires 2 arguments`

13. **"random requires integers"**
    - Run: `print random(1.5, 3)`
    - Error: `requires integer`

14. **"random min must be <= max"**
    - Run: `print random(10, 5)`
    - Error: `min must be <= max`

### tests/string-index.spec.js (NEW)

15. **"string index returns character"**
    - Run: `let s = "hello"\nprint s[0]`
    - Output: `h`

16. **"string last character"**
    - Run: `let s = "hello"\nprint s[4]`
    - Output: `o`

17. **"string index out of bounds"**
    - Run: `let s = "hi"\nprint s[5]`
    - Error: `out of bounds`

18. **"string index negative"**
    - Run: `let s = "hi"\nprint s[-1]`
    - Error: `out of bounds`

19. **"string index with expression"**
    - Run: `let s = "abc"\nlet i = 1\nprint s[i]`
    - Output: `b`

20. **"string index in loop"**
    - Run: `let s = "ab"\nlet i = 0\nwhile (i < len(s)) { print s[i]\ni = i + 1 }`
    - Output: `a\nb`

---

## File Changes

```
src/
  interpreter.js     # Update validateArrayAccess, add num/input/random builtins, onInput/onKey
  lexer.js           # Add float literal support
  scanner.js         # Add float literal support
  reference.js       # Add num, input, random to builtins; string index to arrays
  main.js            # Add input/key handlers
  output-renderer.js # Add showInputField and waitForKeypress methods
styles/
  modals.css         # Style for input field and key prompt
tests/
  input.spec.js      # NEW - 3 tests
  num.spec.js        # NEW - 5 tests
  random.spec.js     # NEW - 6 tests
  string-index.spec.js # NEW - 6 tests
  float.spec.js      # NEW - 6 tests
```

---

## Deliverables

### Interpreter
- [x] Update validateArrayAccess to allow strings
- [x] Add num(x) builtin
- [x] Add random(min, max) builtin
- [x] Add input() builtin with async support
- [x] Add key() builtin with async support

### Lexer/Scanner
- [x] Add float literal support to lexer
- [x] Add float literal support to scanner

### UI
- [x] Create input field for input()
- [x] Create keypress handler for key()
- [x] Wire up onInput and onKey callbacks

### Reference Panel (Syntax Tab)
- [x] Add num() to builtins
- [x] Add input() to builtins
- [x] Add key() to builtins
- [x] Add random() to builtins
- [x] Add string indexing to arrays section
- [x] Update Number type to show float example

### Tests
- [x] Create tests/string-index.spec.js with 6 tests
- [x] Create tests/num.spec.js with 5 tests
- [x] Create tests/random.spec.js with 6 tests
- [x] Create tests/input.spec.js with 3 tests
- [x] Create tests/float.spec.js with 6 tests
- [x] All tests passing (256 total)

### Type System Updates
- [x] Distinguish Integer vs Float in Syntax tab
- [x] Distinguish Integer vs Float in Memory tab (legend + type badges)
- [x] Distinguish Integer vs Float in AST tab (node colors + legend)

---

## Example: Guess the Number

This release unlocks:

```
// Guess the Number
let secret = random(1, 100)
let guess = 0
let attempts = 0

print "I'm thinking of a number between 1 and 100"

while (guess != secret) {
  print "Your guess:"
  guess = num(input())
  attempts = attempts + 1

  if (guess < secret) {
    print "Too low!"
  } else {
    if (guess > secret) {
      print "Too high!"
    }
  }
}

print "Correct! You got it in " + attempts + " attempts"
```

---

## Design Decisions

**input() takes no arguments:** Use `print` for prompts. Cleaner separation of concerns.

**input() vs key():** `input()` waits for a line (Enter), `key()` waits for a single keypress. Both return strings.

**input() returns string:** Always returns a string. Use `num()` to convert to number. Explicit is better than magic.

**num() is explicit conversion:** `num("42")` returns 42. Throws runtime error on invalid input (stops execution).

**input() and key() are async:** Program pauses until user provides input. Integrates with our existing async interpreter.

**random() is inclusive:** `random(1, 6)` can return 1, 2, 3, 4, 5, or 6. More intuitive for beginners.

**String indexing returns string:** `"hello"[0]` returns `"h"` (single-character string), not a character code.

**String index assignment not supported:** `s[0] = "x"` won't work (strings are immutable). Only arrays support index assignment.

---

## Roadmap

| Release | Feature |
|---------|---------|
| 15 | Example Programs ✓ |
| 16 | **Input + Random + String Indexing** (this release) |
| 17 | Graphics/Canvas + keyboard + game loop |

### Programs Unlocked by Release 16
- Guess the Number (with `num()` for string→number)
- Blackjack
- Calculator (string parsing)

### Programs Unlocked by Release 17
- Pong
- Snake

### Backlog (nice-to-have)

- Error handling (try/catch, line numbers in errors)
- String methods (substring, indexOf, etc.)
- Array methods (push, pop, slice, etc.)
- Break/Continue
- Compound assignment (+=, -=)
- For loops
- Objects

---

## Status

**COMPLETE** - 256 tests passing
