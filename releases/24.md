# Release 24: Remove Visualizers + Code Quality

## Status: Phase 1 COMPLETE

## Goal
1. Remove Parser Visualizer and AST Visualizer (keep Memory Visualizer)
2. Address code quality issues to improve maintainability

---

## Part 1: Remove Visualizers (COMPLETE)

### What Was Removed

| Component | Files | Description |
|-----------|-------|-------------|
| Parser Visualizer | `src/parser-renderer.js` | Token display, scanner state |
| AST Visualizer | `src/ast-renderer.js` | AST tree rendering |
| Scanner | `src/scanner.js` | Character-by-character stepping |
| Code Visualizer | `src/visualizer.js` | Source code highlighting |

### What Was Kept

| Component | Files | Description |
|-----------|-------|-------------|
| Memory Visualizer | `src/memory-renderer.js` | Variable state display |
| Output Renderer | `src/output-renderer.js` | Text/graphics output |

### UI Changes

**Before:**
```
Interpreter Pane:
  [Parser] [AST] [Memory]  ← 3 tabs
```

**After:**
```
Interpreter Pane:
  Memory  ← No tabs, just "Memory" heading
```

### Button Changes

| Button | Before | After |
|--------|--------|-------|
| Step | Character-by-character scanner stepping | Step through execution one statement at a time |
| Debug | Animated execution with AST highlighting | Animated execution with memory only |
| Run | Fast execution | Keep |
| Stop | Reset | Keep |

### Deleted Files
- [x] `src/parser-renderer.js`
- [x] `src/ast-renderer.js`
- [x] `src/scanner.js`
- [x] `src/visualizer.js`
- [x] `styles/ast.css`
- [x] `tests/ast.spec.js`
- [x] `tests/ast-visual.spec.js`
- [x] `tests/lexer.spec.js`

### Modified Files
- [x] `index.html` - Removed Parser/AST tabs, simplified to Memory heading only
- [x] `src/main.js` - Removed visualizer imports, rewrote for statement stepping
- [x] `src/interpreter.js` - Added `stepping` and `onStep` support for statement stepping
- [x] `tests/lexer-viz.spec.js` - Rewrote for statement stepping tests
- [x] `tests/memory.spec.js` - Removed tab references
- [x] `tests/call-stack.spec.js` - Removed tab references
- [x] `tests/interpreter.spec.js` - Removed AST tab references
- [x] `tests/ui.spec.js` - Rewrote for new UI (no tabs)
- [x] `tests/print-output.spec.js` - Removed code-executing class references
- [x] `tests/code-highlight.spec.js` - Simplified for new UI

### Implementation Steps (COMPLETE)

1. [x] Remove Parser and AST tabs from index.html
2. [x] Delete src/scanner.js
3. [x] Delete src/parser-renderer.js
4. [x] Delete src/ast-renderer.js
5. [x] Delete src/visualizer.js
6. [x] Delete styles/ast.css
7. [x] Update main.js - remove imports and add statement stepping
8. [x] Update interpreter.js - add stepping/onStep support
9. [x] Delete tests/ast.spec.js
10. [x] Delete tests/ast-visual.spec.js
11. [x] Delete tests/lexer.spec.js
12. [x] Update tests/lexer-viz.spec.js - statement stepping tests
13. [x] Update tests/ui.spec.js - remove tab tests
14. [x] Update tests/memory.spec.js - remove tab clicks
15. [x] Update tests/call-stack.spec.js - remove tab clicks
16. [x] Update tests/interpreter.spec.js - remove AST references
17. [x] Update tests/print-output.spec.js - remove code-executing
18. [x] Update tests/code-highlight.spec.js - simplify
19. [x] Run tests and fix remaining references

---

## Part 2: Code Quality Improvements (PENDING)

### Issue 1: Argument Validation Duplication

**Problem:** 25 repeated argument validation patterns in `interpreter.js`

**Solution:** Extract validation helper to `runtime.js`:

```javascript
export function validateArgs(args, expected, funcName) {
  if (args.length !== expected) {
    throw new RuntimeError(
      `${funcName}() requires ${expected} argument${expected !== 1 ? 's' : ''}, got ${args.length}`
    );
  }
}
```

### Issue 2: OutputRenderer Has Too Many Responsibilities

**Problem:** `output-renderer.js` (479 LOC) handles text output, canvas graphics, and input handling.

**Solution:** Split into focused classes:
- `TextRenderer` - text output only
- `CanvasRenderer` - graphics only
- `InputHandler` - input/key handling
- `OutputRenderer` - facade delegating to above

### Issue 3: main.js State Management

**Problem:** `main.js` (518 LOC) mixes UI logic with state management.

**Solution:** Extract `StateManager` class for state transitions.

### Issue 4: Dead Code - Unused NodeType Export

**Problem:** `NodeType` enum added for deferred optimization.

**Solution:** Remove from constants.js.

### Issue 5: Missing Recursion Depth Limit

**Problem:** No limit on recursive calls.

**Solution:** Add `callDepth` tracking with `MAX_CALL_DEPTH = 1000`.

### Issue 6: tryBuiltinCall() Performance

**Problem:** Linear switch with 25+ cases.

**Solution:** Use dispatch Map for O(1) lookup.

### Issue 7: Missing Architecture Documentation

**Problem:** No high-level docs.

**Solution:** Create `docs/architecture.md`.

---

## Implementation Order

### Phase 1: Remove Visualizers (COMPLETE)
1. [x] Remove Parser/AST tabs
2. [x] Delete scanner, parser-renderer, ast-renderer, visualizer files
3. [x] Delete ast.css
4. [x] Update main.js with statement stepping
5. [x] Update interpreter.js with stepping support
6. [x] Update/delete tests
7. [x] Run full test suite

### Phase 2: Code Quality (PENDING)
1. [ ] Remove unused NodeType export
2. [ ] Extract argument validation helpers
3. [ ] Add recursion depth limit
4. [ ] Refactor tryBuiltinCall() to use Map
5. [ ] Split OutputRenderer
6. [ ] Extract StateManager
7. [ ] Add architecture documentation

---

## File Changes Summary

### Deleted Files
| File | Reason |
|------|--------|
| src/scanner.js | Parser visualizer removed |
| src/parser-renderer.js | Parser visualizer removed |
| src/ast-renderer.js | AST visualizer removed |
| src/visualizer.js | Code highlighting removed |
| styles/ast.css | AST styles removed |
| tests/ast.spec.js | AST tests removed |
| tests/ast-visual.spec.js | AST tests removed |
| tests/lexer.spec.js | Token tab tests removed |

### Modified Files
| File | Changes |
|------|---------|
| index.html | Remove Parser/AST tabs |
| src/main.js | Remove visualizer imports, add statement stepping |
| src/interpreter.js | Add stepping/onStep support |
| tests/lexer-viz.spec.js | Rewrote for statement stepping |
| tests/memory.spec.js | Remove tab references |
| tests/call-stack.spec.js | Remove tab references |
| tests/interpreter.spec.js | Remove AST references |
| tests/ui.spec.js | Simplified UI tests |
| tests/print-output.spec.js | Remove code-executing |
| tests/code-highlight.spec.js | Simplified |

---

## Success Criteria

- [x] All remaining tests pass
- [x] Parser and AST visualizers fully removed
- [x] Memory visualizer still works
- [x] Debug mode still animates (without AST highlight)
- [x] Step mode works with statement-by-statement execution
- [ ] Code quality score improves from 8/10 to 9/10 (Phase 2)
- [x] Codebase is simpler and more maintainable
