# Release 8: Stack Visualization

> Follow CLAUDE.md - do not implement until user approves complete release plan.

## Code Quality Analysis (from Release 7)

**Current codebase:** 4,704 lines across 20 files (12 src, 7 tests, 1 css, 1 html)

### Source Files
| File | Lines | Status |
|------|-------|--------|
| scanner.js | 384 | OK - state machine is inherently complex |
| lexer.js | 370 | OK |
| parser.js | 334 | OK - clean recursive descent |
| main.js | 285 | OK - stable after refactoring |
| ast-renderer.js | 231 | OK |
| interpreter.js | 216 | OK - includes Environment class |
| examples.js | 189 | HAS ISSUE - modal code duplicated |
| reference.js | 138 | HAS ISSUE - modal code duplicated |
| parser-renderer.js | 136 | OK |
| visualizer.js | 101 | OK |
| output-renderer.js | 63 | OK |
| utils.js | 19 | OK |

### Test Files
| File | Lines | Tests | Coverage |
|------|-------|-------|----------|
| lexer-viz.spec.js | 368 | 24 | scanner.js, visualizer.js, reference.js, examples.js |
| parser.spec.js | 242 | 20 | parser.js |
| interpreter.spec.js | 219 | 22 | interpreter.js |
| ast.spec.js | 203 | 14 | ast-renderer.js |
| ui.spec.js | 166 | 15 | main.js, output-renderer.js |
| lexer.spec.js | 150 | 13 | lexer.js |
| variables.spec.js | 131 | 18 | interpreter.js (Environment) |

**Total: 126 tests passing**

---

### OOP & Encapsulation

**Classes (12 total):**
| Class | File | Responsibility | Encapsulation |
|-------|------|----------------|---------------|
| Lexer | lexer.js | Tokenize source code | ✅ Good - internal state hidden |
| Scanner | scanner.js | Step-by-step tokenization | ✅ Good |
| Parser | parser.js | Build AST from tokens | ✅ Good |
| Interpreter | interpreter.js | Execute AST | ✅ Good |
| Environment | interpreter.js | Variable storage | ✅ Good |
| ASTRenderer | ast-renderer.js | Render AST to DOM | ✅ Good |
| ParserRenderer | parser-renderer.js | Render tokens to DOM | ✅ Good |
| OutputRenderer | output-renderer.js | Render output/errors | ✅ Good |
| CodeVisualizer | visualizer.js | Highlight source code | ✅ Good |
| ReferencePanel | reference.js | Show language reference | ⚠️ Modal logic duplicated |
| ExamplesManager | examples.js | Manage example programs | ⚠️ Modal logic duplicated |
| RuntimeError | interpreter.js | Custom error type | ✅ Good |

**Assessment:** Good use of OOP. Each class has a single responsibility.

---

### Separation of Concerns

| Layer | Files | Status |
|-------|-------|--------|
| **Lexing** | lexer.js, scanner.js | ✅ Separate from parsing |
| **Parsing** | parser.js | ✅ Separate from interpretation |
| **Interpretation** | interpreter.js | ✅ Separate from rendering |
| **Rendering** | ast-renderer.js, parser-renderer.js, output-renderer.js | ✅ Each tab has own renderer |
| **UI/Orchestration** | main.js | ✅ Coordinates components |
| **Utilities** | utils.js | ✅ Shared character functions |
| **Modals** | reference.js, examples.js | ⚠️ Each manages own modal (duplicated) |

**Assessment:** Good separation. Main.js orchestrates, each module handles its domain.

---

### DRY (Don't Repeat Yourself)

**Issues Found:**

1. **Modal rendering duplicated** (SHOULD FIX)
   - `reference.js` and `examples.js` both implement:
     - Create overlay div
     - Create panel div
     - Handle click-outside-to-close
     - Close button handling
   - **Solution:** Extract `Modal` base class or utility

```javascript
// Duplicated pattern in both files:
this.overlay = document.createElement('div');
this.overlay.className = 'modal-overlay';
this.overlay.onclick = (e) => {
  if (e.target === this.overlay) this.close();
};
this.panel = document.createElement('div');
this.panel.className = 'modal-panel';
// ... render content ...
document.body.appendChild(this.overlay);
```

**Previously Fixed:**
- ✅ `isDigit`, `isAlpha`, `isAlphaNumeric` - extracted to utils.js (Release 6)
- ✅ Tab rendering - each tab has own renderer class (Release 7)

---

### Code Coverage

| Source File | Direct Tests | Indirect Tests | Coverage |
|-------------|--------------|----------------|----------|
| lexer.js | lexer.spec.js | - | ✅ High |
| scanner.js | lexer-viz.spec.js | - | ✅ High |
| parser.js | parser.spec.js | - | ✅ High |
| interpreter.js | interpreter.spec.js, variables.spec.js | - | ✅ High |
| ast-renderer.js | ast.spec.js | - | ✅ High |
| main.js | ui.spec.js | all specs | ✅ High |
| visualizer.js | lexer-viz.spec.js | - | ✅ Medium |
| parser-renderer.js | - | ui.spec.js, lexer-viz.spec.js | ⚠️ Indirect only |
| output-renderer.js | - | ui.spec.js, interpreter.spec.js | ⚠️ Indirect only |
| reference.js | lexer-viz.spec.js | - | ✅ Medium |
| examples.js | lexer-viz.spec.js | - | ✅ Medium |
| utils.js | - | lexer.spec.js, lexer-viz.spec.js | ⚠️ Indirect only |

**Assessment:** Good coverage overall. Renderers tested indirectly through integration tests.

---

### Issues to Address

| Priority | Issue | Action |
|----------|-------|--------|
| **SHOULD FIX** | Modal code duplicated in reference.js and examples.js | Extract Modal base class |
| **MONITOR** | CSS at 695 lines | Consider splitting if grows |
| **MONITOR** | parser-renderer.js, output-renderer.js have indirect coverage only | Consider unit tests if they grow complex |

---

### Code Quality Wins
- Good OOP with 12 well-encapsulated classes
- Clear separation of concerns (lexing → parsing → interpreting → rendering)
- Each tab has dedicated renderer class
- Environment class ready for visualization (has `getAll()` method)
- CharUtils extracted to eliminate duplicate code (Release 6)

---

## Goal

Add **Stack Visualization** - a panel that shows variables currently in scope during execution. This helps Connor understand:
- What variables exist at any point in the program
- What values those variables hold
- How values change as the program executes

This is the first step toward understanding memory and state in programs.

## Features

### Variables Panel

A new panel (or section within existing panel) that displays:

```
┌─────────────────────────┐
│ Variables               │
├─────────────────────────┤
│ message  "Hello, Connor"│
│ count    42             │
│ x        10             │
└─────────────────────────┘
```

### Real-time Updates

During animated execution (Run button):
- Variables panel updates as `let` statements are executed
- Values update as assignments happen
- Newly changed values could highlight briefly

### Type Indicators

Show the type alongside the value:
```
message  str   "Hello, Connor"
count    num   42
isReady  bool  true
```

Or use color coding:
- Blue for numbers
- Green for strings
- Purple for booleans

## Implementation

### New Component: StackRenderer

```javascript
// src/stack-renderer.js
class StackRenderer {
  constructor(container) {
    this.container = container;
  }

  // Render current variable state
  render(environment) {
    const variables = environment.getAll();

    if (variables.length === 0) {
      this.container.innerHTML = '<div class="stack-empty">(no variables)</div>';
      return;
    }

    let html = '<div class="stack-list">';
    for (const [name, value] of variables) {
      const type = this.getType(value);
      const displayValue = this.formatValue(value);
      html += `
        <div class="stack-var">
          <span class="var-name">${name}</span>
          <span class="var-type">${type}</span>
          <span class="var-value var-${type}">${displayValue}</span>
        </div>
      `;
    }
    html += '</div>';
    this.container.innerHTML = html;
  }

  getType(value) {
    if (typeof value === 'number') return 'num';
    if (typeof value === 'string') return 'str';
    if (typeof value === 'boolean') return 'bool';
    return 'unknown';
  }

  formatValue(value) {
    if (typeof value === 'string') return `"${value}"`;
    return String(value);
  }

  // Highlight a variable that just changed
  highlightVariable(name) {
    const varEl = this.container.querySelector(`[data-name="${name}"]`);
    if (varEl) {
      varEl.classList.add('var-changed');
      setTimeout(() => varEl.classList.remove('var-changed'), 500);
    }
  }

  clear() {
    this.container.innerHTML = '';
  }
}
```

### UI Updates

**Option A: Fourth Tab**
Add "Variables" tab alongside Parser, AST, Output

**Option B: Side Panel**
Add a narrow panel below/beside the output pane that's always visible during execution

**Option C: Overlay during Run**
Show variables panel overlaid on the AST during animated execution

Recommendation: **Option A (Fourth Tab)** - consistent with existing UI pattern, simple to implement.

### Interpreter Hooks

Update interpreter to notify when variables change:

```javascript
class Interpreter {
  constructor(options = {}) {
    // ... existing options ...
    this.onVariableChange = options.onVariableChange || (() => {});
  }

  async execute(node) {
    // ...
    case 'LetStatement': {
      const value = await this.evaluate(node.value);
      this.environment.define(node.name, value);
      this.onVariableChange(node.name, value, 'define');
      result = value;
      break;
    }

    case 'AssignStatement': {
      const value = await this.evaluate(node.value);
      this.environment.assign(node.name, value);
      this.onVariableChange(node.name, value, 'assign');
      result = value;
      break;
    }
    // ...
  }
}
```

### Main.js Updates

```javascript
const stackRenderer = new StackRenderer(tabVariables);

async function runAnimated() {
  // ...
  const interpreter = new Interpreter({
    stepDelay: 5000,
    onNodeEnter: (node) => astRenderer.highlightNode(node),
    onVariableChange: (name, value, action) => {
      stackRenderer.render(interpreter.environment);
      stackRenderer.highlightVariable(name);
    }
  });
  // ...
}
```

## File Changes

```
src/
  stack-renderer.js    # NEW - Variables panel rendering
  interpreter.js       # Add onVariableChange callback
  main.js              # Add stackRenderer, connect to interpreter
index.html             # Add Variables tab
styles/main.css        # Stack visualization styles
tests/
  stack.spec.js        # NEW - Stack visualization tests
```

## Playwright Tests

### Display Tests

1. **"variables tab exists"**
   - Verify Variables tab button exists

2. **"variables tab initially empty"**
   - Click Variables tab
   - Verify shows "(no variables)" or empty state

3. **"variables appear after let statement"**
   - Run: `let x = 42`
   - Verify Variables tab shows `x` with value `42`

4. **"multiple variables displayed"**
   - Run: `let a = 1\nlet b = 2\nlet c = 3`
   - Verify all three variables shown

5. **"variable values update on assignment"**
   - Run: `let x = 1\nx = 2`
   - Verify `x` shows value `2`

### Type Display Tests

6. **"number type displayed"**
   - Run: `let n = 42`
   - Verify type indicator shows "num"

7. **"string type displayed"**
   - Run: `let s = "hello"`
   - Verify type indicator shows "str"

8. **"boolean type displayed"**
   - Run: `let b = true`
   - Verify type indicator shows "bool"

### Dynamic Typing Tests

9. **"type changes when variable reassigned"**
   - Run: `let x = 42\nx = "hello"`
   - Verify type changes from "num" to "str"

### Integration Tests

10. **"variables panel updates during animated run"**
    - Use Run (animated) with a program that has multiple variables
    - Verify panel updates as each `let` executes

11. **"variables cleared on reset"**
    - Run a program, then click Reset
    - Verify Variables panel is cleared

12. **"variables panel works with Run Fast"**
    - Click Run Fast
    - Verify final variable state is shown

## Deliverables

### Code Quality Fix (from analysis)
- [ ] Create src/modal.js - Extract Modal base class from reference.js and examples.js
- [ ] Refactor reference.js to use Modal class
- [ ] Refactor examples.js to use Modal class

### Stack Visualization Feature
- [ ] Create src/stack-renderer.js
- [ ] Add onVariableChange callback to interpreter.js
- [ ] Update main.js with stackRenderer
- [ ] Add Variables tab to index.html
- [ ] Add CSS styles for variables panel
- [ ] Update index.html to include modal.js and stack-renderer.js
- [ ] Create tests/stack.spec.js with 12 tests
- [ ] All tests passing (138 total: 126 existing + 12 new)

## Notes for Future Releases

> **Stack Frames:** When functions are added (Release 13-14), the stack visualization will need to show multiple frames/scopes, not just global variables.

> **AST Type Representation:** In a future release, represent variable types more explicitly in the AST visualization.

## Status

**DRAFT** - Awaiting user approval
