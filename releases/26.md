# Release 26: Load Program from URL

## Goal
Add ability to load a `.tpl` program file from a URL, making it easy to share and load example programs.

## User Flow

1. User clicks "Load" button in toolbar
2. Browser prompts for URL input
3. URL is validated to end with `.tpl`
4. File is fetched and loaded into the code editor
5. Success or error message displayed in output pane

---

## Part 1: HTML Changes

### Add Load Button to Toolbar

**File:** `index.html`

```html
<!-- Current toolbar (lines 14-20) -->
<nav id="toolbar">
  <button id="step-btn">Step</button>
  <button id="debug-btn">Debug</button>
  <button id="run-btn">Run</button>
  <button id="load-btn">Load</button>  <!-- NEW -->
  <button id="stop-btn" disabled>Stop</button>
  <button id="resume-btn" class="hidden">Resume</button>
</nav>
```

**Position:** After Run button, before Stop button

---

## Part 2: CSS Changes

### Add Load Button Styling

**File:** `styles/base.css`

```css
/* Add after #stop-btn styles (around line 101) */

#load-btn {
  background: #17a2b8;
  color: white;
}

#load-btn:hover:not(:disabled) {
  background: #138496;
}
```

---

## Part 3: JavaScript Implementation

### Add Load Functionality

**File:** `src/main.js`

```javascript
// In init() function, add DOM reference (around line 42):
const loadBtn = document.getElementById('load-btn');

// Add load function (around line 378, before event listeners):

// Load - fetch a .tpl file from URL
async function load() {
  const url = prompt('Enter URL to a .tpl file:');

  // User cancelled
  if (url === null) {
    return;
  }

  // Empty input
  if (!url.trim()) {
    outputRenderer.renderErrors([], [], [{ message: 'No URL provided.' }]);
    return;
  }

  // Validate .tpl extension
  if (!url.toLowerCase().endsWith('.tpl')) {
    outputRenderer.renderErrors([], [], [{ message: 'URL must end with .tpl' }]);
    return;
  }

  try {
    const response = await fetch(url);

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const content = await response.text();
    codeEditor.value = content;
    updateLineCount();
    outputRenderer.clear();
    outputRenderer.renderMessage(`Loaded: ${url}`);
  } catch (error) {
    outputRenderer.renderErrors([], [], [{ message: `Failed to load: ${error.message}` }]);
  }
}

// Add event listener (around line 385):
loadBtn.addEventListener('click', load);

// Update updateUI() to disable Load during execution (in switch statement):
case 'edit':
  // ... existing code ...
  loadBtn.disabled = false;  // ADD
  break;

case 'stepping':
  // ... existing code ...
  loadBtn.disabled = true;   // ADD
  break;

case 'running':
  // ... existing code ...
  loadBtn.disabled = true;   // ADD
  break;

case 'done':
  // ... existing code ...
  loadBtn.disabled = false;  // ADD
  break;
```

---

## Part 4: Tests

### UI Tests

**File:** `tests/load-url.spec.js`

```javascript
const { test, expect } = require('@playwright/test');

// Helper to run code and get output
async function getOutput(page) {
  return await page.locator('#output').textContent();
}

// === UI Tests ===

test('load button exists and is visible', async ({ page }) => {
  await page.goto('/');
  const loadBtn = page.locator('#load-btn');
  await expect(loadBtn).toBeVisible();
  await expect(loadBtn).toHaveText('Load');
});

test('load button is enabled in edit mode', async ({ page }) => {
  await page.goto('/');
  const loadBtn = page.locator('#load-btn');
  await expect(loadBtn).not.toBeDisabled();
});

test('load button is disabled during run', async ({ page }) => {
  await page.goto('/');

  // Start a long-running program
  await page.fill('#code-editor', `
    let i = 0
    while (i < 10000) {
      i = i + 1
    }
  `);

  // Click run and immediately check load button
  await page.click('#run-btn');
  const loadBtn = page.locator('#load-btn');
  await expect(loadBtn).toBeDisabled();
});

// === Validation Tests ===

test('empty URL shows error', async ({ page }) => {
  await page.goto('/');

  // Mock prompt to return empty string
  await page.evaluate(() => {
    window.prompt = () => '';
  });

  await page.click('#load-btn');
  const output = await getOutput(page);
  expect(output).toContain('No URL provided');
});

test('URL without .tpl extension shows error', async ({ page }) => {
  await page.goto('/');

  // Mock prompt to return invalid URL
  await page.evaluate(() => {
    window.prompt = () => 'https://example.com/file.txt';
  });

  await page.click('#load-btn');
  const output = await getOutput(page);
  expect(output).toContain('must end with .tpl');
});

test('cancelled prompt does nothing', async ({ page }) => {
  await page.goto('/');

  // Mock prompt to return null (cancelled)
  await page.evaluate(() => {
    window.prompt = () => null;
  });

  // Pre-fill editor with some content
  await page.fill('#code-editor', 'let x = 1');

  await page.click('#load-btn');

  // Editor should remain unchanged
  const editor = page.locator('#code-editor');
  await expect(editor).toHaveValue('let x = 1');
});

// === Network Tests ===

test('failed fetch shows error', async ({ page }) => {
  await page.goto('/');

  // Mock prompt to return a URL that will fail
  await page.evaluate(() => {
    window.prompt = () => 'https://nonexistent-domain-12345.com/test.tpl';
  });

  await page.click('#load-btn');

  // Wait for error message
  await page.waitForFunction(() => {
    const output = document.getElementById('output');
    return output && output.textContent.includes('Failed to load');
  }, { timeout: 10000 });

  const output = await getOutput(page);
  expect(output).toContain('Failed to load');
});

test('404 response shows error', async ({ page }) => {
  await page.goto('/');

  // Route to simulate 404
  await page.route('**/nonexistent.tpl', route => {
    route.fulfill({
      status: 404,
      statusText: 'Not Found'
    });
  });

  await page.evaluate(() => {
    window.prompt = () => 'http://localhost:8080/nonexistent.tpl';
  });

  await page.click('#load-btn');

  await page.waitForFunction(() => {
    const output = document.getElementById('output');
    return output && output.textContent.includes('404');
  }, { timeout: 5000 });

  const output = await getOutput(page);
  expect(output).toContain('404');
});

// === Success Tests ===

test('successful load populates editor', async ({ page }) => {
  await page.goto('/');

  // Route to simulate successful fetch
  await page.route('**/test.tpl', route => {
    route.fulfill({
      status: 200,
      contentType: 'text/plain',
      body: 'let x = 42\nprint(x)'
    });
  });

  await page.evaluate(() => {
    window.prompt = () => 'http://localhost:8080/test.tpl';
  });

  await page.click('#load-btn');

  // Wait for editor to be populated
  await page.waitForFunction(() => {
    const editor = document.getElementById('code-editor');
    return editor && editor.value.includes('let x = 42');
  }, { timeout: 5000 });

  const editor = page.locator('#code-editor');
  await expect(editor).toHaveValue('let x = 42\nprint(x)');
});

test('successful load shows success message', async ({ page }) => {
  await page.goto('/');

  await page.route('**/example.tpl', route => {
    route.fulfill({
      status: 200,
      contentType: 'text/plain',
      body: 'print("hello")'
    });
  });

  await page.evaluate(() => {
    window.prompt = () => 'http://localhost:8080/example.tpl';
  });

  await page.click('#load-btn');

  await page.waitForFunction(() => {
    const output = document.getElementById('output');
    return output && output.textContent.includes('Loaded:');
  }, { timeout: 5000 });

  const output = await getOutput(page);
  expect(output).toContain('Loaded:');
  expect(output).toContain('example.tpl');
});

test('successful load updates line count', async ({ page }) => {
  await page.goto('/');

  await page.route('**/multiline.tpl', route => {
    route.fulfill({
      status: 200,
      contentType: 'text/plain',
      body: 'let x = 1\nlet y = 2\nlet z = 3\nprint(x + y + z)'
    });
  });

  await page.evaluate(() => {
    window.prompt = () => 'http://localhost:8080/multiline.tpl';
  });

  await page.click('#load-btn');

  await page.waitForFunction(() => {
    const lineCount = document.getElementById('line-count');
    return lineCount && lineCount.textContent.includes('4');
  }, { timeout: 5000 });

  const lineCount = page.locator('#line-count');
  await expect(lineCount).toContainText('4 lines');
});

// === Case Sensitivity Test ===

test('.TPL extension is accepted (case insensitive)', async ({ page }) => {
  await page.goto('/');

  await page.route('**/EXAMPLE.TPL', route => {
    route.fulfill({
      status: 200,
      contentType: 'text/plain',
      body: 'print("uppercase")'
    });
  });

  await page.evaluate(() => {
    window.prompt = () => 'http://localhost:8080/EXAMPLE.TPL';
  });

  await page.click('#load-btn');

  await page.waitForFunction(() => {
    const editor = document.getElementById('code-editor');
    return editor && editor.value.includes('uppercase');
  }, { timeout: 5000 });

  const editor = page.locator('#code-editor');
  await expect(editor).toHaveValue('print("uppercase")');
});
```

---

## File Changes Summary

| File | Changes |
|------|---------|
| index.html | Add Load button to toolbar |
| styles/base.css | Add #load-btn styling |
| src/main.js | Add load() function, DOM reference, event listener, updateUI() changes |
| tests/load-url.spec.js | New test file with 12 tests |

---

## Implementation Order

1. [ ] Add Load button to index.html
2. [ ] Add Load button CSS to base.css
3. [ ] Add load() function to main.js
4. [ ] Add DOM reference and event listener
5. [ ] Update updateUI() for disabled states
6. [ ] Create tests/load-url.spec.js
7. [ ] Run all tests

---

## Edge Cases Considered

| Case | Behavior |
|------|----------|
| User cancels prompt | No action, editor unchanged |
| Empty URL | Error: "No URL provided" |
| URL without .tpl | Error: "URL must end with .tpl" |
| Network failure | Error: "Failed to load: [message]" |
| 404 response | Error: "HTTP 404: Not Found" |
| CORS blocked | Error: "Failed to load: [CORS error]" |
| Large file | Loads fully (browser handles memory) |
| UTF-8 content | Works (fetch default encoding) |

---

## Security Considerations

- Only `.tpl` files can be loaded (validated by extension)
- CORS policy enforced by browser (cannot load from arbitrary domains unless they allow it)
- No code execution on load - user must click Run
- URL is displayed in success message so user sees what was loaded

---

## Future Enhancements (Not in this release)

- Save button to download current code as .tpl file
- Recent URLs dropdown
- Load from GitHub Gist
- Drag-and-drop .tpl files
