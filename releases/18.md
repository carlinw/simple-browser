# Release 18: Graphics and Game Loop

> Follow CLAUDE.md - do not implement until user approves complete release plan.

## Goals

Add canvas graphics and real-time input to enable games like Pong and Snake.

---

## New Features

### 1. sleep(ms) - Pause Execution

```
print "Starting in 3..."
sleep(1000)
print "2..."
sleep(1000)
print "1..."
sleep(1000)
print "Go!"
```

- Pauses execution for specified milliseconds
- Essential for game loop timing (60fps = sleep(16))

### 2. pressed(key) - Non-blocking Key Check

```
while (true) {
  if (pressed("left")) {
    x = x - 5
  }
  if (pressed("right")) {
    x = x + 5
  }
  sleep(16)
}
```

- Returns true if key is currently held down, false otherwise
- Does NOT block - returns immediately
- Key names: "left", "right", "up", "down", "space", "a"-"z", "0"-"9"

### 3. clear() - Clear Canvas

```
clear()
```

- Clears the entire canvas to black

### 4. color(name) - Set Drawing Color

```
color("red")
rect(10, 10, 50, 50)

color("blue")
circle(100, 100, 25)
```

Available colors (10):
- "black"
- "white"
- "red"
- "green"
- "blue"
- "yellow"
- "orange"
- "purple"
- "cyan"
- "pink"

### 5. rect(x, y, w, h) - Draw Rectangle

```
rect(10, 10, 100, 50)  // x, y, width, height
```

- Draws filled rectangle at position (x, y) with given dimensions
- Uses current color

### 6. circle(x, y, r) - Draw Circle

```
circle(100, 100, 25)  // centerX, centerY, radius
```

- Draws filled circle centered at (x, y) with given radius
- Uses current color

### 7. line(x1, y1, x2, y2) - Draw Line

```
line(0, 0, 100, 100)  // from (0,0) to (100,100)
```

- Draws line between two points
- Uses current color

---

## Implementation

### UI Changes

#### Canvas in Output Pane

When graphics functions are used, the output pane shows a canvas instead of text:

```javascript
// In output-renderer.js
showCanvas() {
  this.canvas = document.createElement('canvas');
  this.canvas.width = 400;
  this.canvas.height = 300;
  this.canvas.className = 'output-canvas';
  this.container.innerHTML = '';
  this.container.appendChild(this.canvas);
  this.ctx = this.canvas.getContext('2d');
  // Default to black background
  this.ctx.fillStyle = 'black';
  this.ctx.fillRect(0, 0, 400, 300);
}
```

### Interpreter Changes

#### Add Graphics Builtins

```javascript
// In tryBuiltinCall()

case 'sleep': {
  if (args.length !== 1) {
    throw new RuntimeError('sleep() requires 1 argument');
  }
  const ms = args[0];
  if (typeof ms !== 'number' || ms < 0) {
    throw new RuntimeError('sleep() requires a positive number');
  }
  await this.delay(ms);
  return null;
}

case 'pressed': {
  if (args.length !== 1) {
    throw new RuntimeError('pressed() requires 1 argument');
  }
  const key = args[0];
  if (typeof key !== 'string') {
    throw new RuntimeError('pressed() requires a string argument');
  }
  return this.isKeyPressed(key);
}

case 'clear': {
  if (args.length !== 0) {
    throw new RuntimeError('clear() takes no arguments');
  }
  this.onClear();
  return null;
}

case 'color': {
  if (args.length !== 1) {
    throw new RuntimeError('color() requires 1 argument');
  }
  const name = args[0];
  if (typeof name !== 'string') {
    throw new RuntimeError('color() requires a string argument');
  }
  this.onColor(name);
  return null;
}

case 'rect': {
  if (args.length !== 4) {
    throw new RuntimeError('rect() requires 4 arguments (x, y, width, height)');
  }
  const [x, y, w, h] = args;
  this.onRect(x, y, w, h);
  return null;
}

case 'circle': {
  if (args.length !== 3) {
    throw new RuntimeError('circle() requires 3 arguments (x, y, radius)');
  }
  const [x, y, r] = args;
  this.onCircle(x, y, r);
  return null;
}

case 'line': {
  if (args.length !== 4) {
    throw new RuntimeError('line() requires 4 arguments (x1, y1, x2, y2)');
  }
  const [x1, y1, x2, y2] = args;
  this.onLine(x1, y1, x2, y2);
  return null;
}
```

#### Keyboard State Tracking

```javascript
// In main.js
const keysPressed = new Set();

document.addEventListener('keydown', (e) => {
  keysPressed.add(normalizeKey(e.key));
});

document.addEventListener('keyup', (e) => {
  keysPressed.delete(normalizeKey(e.key));
});

function normalizeKey(key) {
  // Map arrow keys to simple names
  const keyMap = {
    'ArrowLeft': 'left',
    'ArrowRight': 'right',
    'ArrowUp': 'up',
    'ArrowDown': 'down',
    ' ': 'space'
  };
  return keyMap[key] || key.toLowerCase();
}

// Pass to interpreter
const interpreter = new Interpreter({
  // ... existing options ...
  isKeyPressed: (key) => keysPressed.has(key),
});
```

### Reference Panel Changes

Add to builtins:

```javascript
builtins: [
  // ... existing ...
  { name: 'sleep(ms)', desc: 'pause for milliseconds' },
  { name: 'pressed(key)', desc: 'true if key is held down' },
  { name: 'clear()', desc: 'clear the canvas' },
  { name: 'color(name)', desc: 'set drawing color' },
  { name: 'rect(x,y,w,h)', desc: 'draw rectangle' },
  { name: 'circle(x,y,r)', desc: 'draw circle' },
  { name: 'line(x1,y1,x2,y2)', desc: 'draw line' },
]
```

Add new section for colors:

```javascript
colors: [
  { name: 'black', desc: '#000000' },
  { name: 'white', desc: '#ffffff' },
  { name: 'red', desc: '#ff0000' },
  { name: 'green', desc: '#00ff00' },
  { name: 'blue', desc: '#0000ff' },
  { name: 'yellow', desc: '#ffff00' },
  { name: 'orange', desc: '#ff8800' },
  { name: 'purple', desc: '#8800ff' },
  { name: 'cyan', desc: '#00ffff' },
  { name: 'pink', desc: '#ff88ff' },
]
```

---

## Tests

### tests/sleep.spec.js (NEW)

1. **"sleep pauses execution"**
   - Run code that prints before and after sleep
   - Verify timing is approximately correct

2. **"sleep requires positive number"**
   - Run: `sleep(-100)`
   - Error: `positive number`

3. **"sleep requires number"**
   - Run: `sleep("fast")`
   - Error: `requires a positive number`

### tests/pressed.spec.js (NEW)

4. **"pressed returns false when key not pressed"**
   - Run: `print pressed("left")`
   - Output: `false`

5. **"pressed returns true when key is held"**
   - Simulate keydown for "a"
   - Run: `print pressed("a")`
   - Output: `true`

6. **"pressed requires string argument"**
   - Run: `print pressed(123)`
   - Error: `requires a string`

### tests/graphics.spec.js (NEW)

7. **"clear creates canvas"**
   - Run: `clear()`
   - Canvas element should exist

8. **"rect draws on canvas"**
   - Run: `color("red")\nrect(10, 10, 50, 50)`
   - Canvas should have red pixels

9. **"circle draws on canvas"**
   - Run: `color("blue")\ncircle(100, 100, 25)`
   - Canvas should have blue pixels

10. **"line draws on canvas"**
    - Run: `color("white")\nline(0, 0, 100, 100)`
    - Canvas should have white pixels

11. **"color changes drawing color"**
    - Run: `color("green")\nrect(0, 0, 10, 10)\ncolor("yellow")\nrect(20, 0, 10, 10)`
    - Canvas should have both colors

12. **"invalid color throws error"**
    - Run: `color("rainbow")`
    - Error: `Unknown color`

---

## File Changes

```
src/
  interpreter.js     # Add sleep, pressed, clear, color, rect, circle, line builtins
  output-renderer.js # Add canvas support
  main.js            # Add keyboard state tracking, graphics callbacks
  reference.js       # Add new builtins and colors section
styles/
  modals.css         # Add canvas styling
tests/
  sleep.spec.js      # NEW - 3 tests
  pressed.spec.js    # NEW - 3 tests
  graphics.spec.js   # NEW - 6 tests
```

---

## Deliverables

### Interpreter
- [ ] Add sleep(ms) builtin
- [ ] Add pressed(key) builtin
- [ ] Add clear() builtin
- [ ] Add color(name) builtin
- [ ] Add rect(x, y, w, h) builtin
- [ ] Add circle(x, y, r) builtin
- [ ] Add line(x1, y1, x2, y2) builtin

### UI
- [ ] Add canvas element to output pane
- [ ] Implement keyboard state tracking
- [ ] Wire up graphics callbacks

### Reference Panel (Syntax Tab)
- [ ] Add sleep() to builtins
- [ ] Add pressed() to builtins
- [ ] Add graphics functions to builtins
- [ ] Add colors section

### Tests
- [ ] Create tests/sleep.spec.js with 3 tests
- [ ] Create tests/pressed.spec.js with 3 tests
- [ ] Create tests/graphics.spec.js with 6 tests
- [ ] All tests passing (268+ total)

---

## Example: Bouncing Ball

```
// Bouncing Ball
let x = 200
let y = 150
let dx = 3
let dy = 2

while (true) {
  clear()

  // Draw ball
  color("white")
  circle(x, y, 10)

  // Move ball
  x = x + dx
  y = y + dy

  // Bounce off walls
  if (x < 10 or x > 390) {
    dx = 0 - dx
  }
  if (y < 10 or y > 290) {
    dy = 0 - dy
  }

  sleep(16)
}
```

## Example: Simple Pong

```
// Simple Pong
let paddleY = 130
let ballX = 200
let ballY = 150
let ballDX = 3
let ballDY = 2

while (true) {
  clear()

  // Draw paddle
  color("white")
  rect(10, paddleY, 10, 40)

  // Draw ball
  circle(ballX, ballY, 5)

  // Move paddle
  if (pressed("up") and paddleY > 0) {
    paddleY = paddleY - 5
  }
  if (pressed("down") and paddleY < 260) {
    paddleY = paddleY + 5
  }

  // Move ball
  ballX = ballX + ballDX
  ballY = ballY + ballDY

  // Bounce off walls
  if (ballY < 5 or ballY > 295) {
    ballDY = 0 - ballDY
  }
  if (ballX > 395) {
    ballDX = 0 - ballDX
  }

  // Bounce off paddle
  if (ballX < 25 and ballY > paddleY and ballY < paddleY + 40) {
    ballDX = 0 - ballDX
  }

  // Reset if ball goes off left
  if (ballX < 0) {
    ballX = 200
    ballY = 150
  }

  sleep(16)
}
```

---

## Roadmap

| Release | Feature |
|---------|---------|
| 17 | Interactive Example Programs âœ“ |
| 18 | **Graphics and Game Loop** (this release) |
| 19 | Graphics Example Programs (Pong, Snake, etc.) |

### Backlog (nice-to-have)

- Error handling (try/catch, line numbers in errors)
- String methods (substring, indexOf, etc.)
- Array methods (push, pop, slice, etc.)
- Break/Continue
- Compound assignment (+=, -=)
- For loops
- Objects
- Text drawing on canvas

---

## Status

**PLANNING** - Awaiting user approval
