# Release 20: else if + ES Modules

## Status: COMPLETE

## Overview

1. Add `else if` syntax to avoid deeply nested conditionals
2. Migrate codebase to ES modules (import/export)

---

## Deferred to Future Release

### Dictionaries
Add dictionary data type (key-value pairs) to enable:
- Mapping keys to values: `let beats = {"r": "s", "p": "r", "s": "p"}`
- Lookup by key: `beats["r"]` returns `"s"`
- Replacing chains of conditionals with data-driven lookups

**Benefit:** The RPS example currently needs 9 explicit conditions to check all win/tie/lose cases. With dictionaries, it becomes a single lookup: `if (beats[player] equals computer) { ... }`

---

## Feature 1: else if

### Current Problem
Without `else if`, multi-way branches require deep nesting:

```
if (op equals "+") {
  result = a + b
} else {
  if (op equals "-") {
    result = a - b
  } else {
    if (op equals "*") {
      result = a * b
    } else {
      result = a / b
    }
  }
}
```

### With else if
```
if (op equals "+") {
  result = a + b
} else if (op equals "-") {
  result = a - b
} else if (op equals "*") {
  result = a * b
} else {
  result = a / b
}
```

### Implementation

**Parser change** (`src/parser.js`):

Currently `parseIfStatement()` parses:
```
if (condition) { ... } else { ... }
```

Need to also accept:
```
if (condition) { ... } else if (condition2) { ... } else { ... }
```

The `else if` is syntactic sugar - it parses as `else { if ... }` but without requiring braces.

**Grammar:**
```
ifStatement = "if" "(" expression ")" block ("else" (ifStatement | block))?
```

**Files to modify:**
- `src/parser.js` - Update `parseIfStatement()`
- `language-help.html` - Document `else if`
- `tests/interpreter.spec.js` - Add tests
- Example programs - Simplify nested if/else chains

### Tests to Add

All tests are **end-to-end Playwright tests** (no unit tests). Tests work by:
1. Navigate to page
2. Fill `#code-editor` with test code
3. Click `#run-btn` (or `#parse-btn` for parser tests)
4. Check `#output` or AST panel for expected result

**Parser tests** (`tests/parser.spec.js`):
- `else if parses correctly` - Verify AST structure
- `else if chain parses correctly` - Multiple else if branches
- `else if with final else parses correctly`

**Interpreter tests** (`tests/interpreter.spec.js`):
- `else if executes first matching branch` - First condition true
- `else if executes second branch` - Second condition true
- `else if executes else branch` - No conditions true
- `else if skips remaining branches after match` - Verify short-circuit
- `else if chain with multiple conditions` - 3+ branches

**Example test scenarios:**
```
// Test 1: First branch matches
let x = 1
if (x equals 1) {
  print("one")
} else if (x equals 2) {
  print("two")
} else {
  print("other")
}
// Output: "one"

// Test 2: Second branch matches
let x = 2
if (x equals 1) {
  print("one")
} else if (x equals 2) {
  print("two")
} else {
  print("other")
}
// Output: "two"

// Test 3: Else branch matches
let x = 99
if (x equals 1) {
  print("one")
} else if (x equals 2) {
  print("two")
} else {
  print("other")
}
// Output: "other"

// Test 4: Long chain
let grade = 85
if (grade >= 90) {
  print("A")
} else if (grade >= 80) {
  print("B")
} else if (grade >= 70) {
  print("C")
} else if (grade >= 60) {
  print("D")
} else {
  print("F")
}
// Output: "B"
```

### Example Programs to Update
- `calculator.js` - 4 levels → flat
- `rps.js` - 6 levels → flat
- `control-flow.js` - Add `else if` example
- `dice.js` - Nested checks → flat

---

## Archive: Example Program Comment Statistics

Snapshot from Release 19 session for tracking documentation quality.

| Example | Total LOC | Comments | % Comments |
|---------|-----------|----------|------------|
| fizzbuzz | 33 | 14 | 42.4% |
| tokenizer-demo | 18 | 7 | 38.8% |
| arithmetic | 16 | 5 | 31.2% |
| comparisons | 18 | 5 | 27.7% |
| fibonacci | 31 | 8 | 25.8% |
| primes | 56 | 14 | 25.0% |
| variables | 16 | 4 | 25.0% |
| arrays | 23 | 5 | 21.7% |
| towers-of-hanoi | 176 | 38 | 21.5% |
| strings | 39 | 8 | 20.5% |
| flappy-bird | 73 | 13 | 17.8% |
| drawing | 45 | 8 | 17.7% |
| pong | 63 | 11 | 17.4% |
| bouncing-ball | 30 | 5 | 16.6% |
| game-of-life | 143 | 23 | 16.0% |
| operators | 35 | 5 | 14.2% |
| starfield | 58 | 8 | 13.7% |
| breakout | 110 | 15 | 13.6% |
| functions | 39 | 5 | 12.8% |
| control-flow | 48 | 6 | 12.5% |
| snake | 82 | 10 | 12.1% |
| maze-generator | 190 | 21 | 11.0% |
| computer-guesses | 34 | 3 | 8.8% |
| guess-number | 25 | 2 | 8.0% |
| tetris | 180 | 14 | 7.7% |
| dice | 26 | 2 | 7.6% |
| maze-solver | 308 | 21 | 6.8% |
| calculator | 31 | 2 | 6.4% |
| rps | 70 | 4 | 5.7% |

**Average: ~17%** | Well-commented (>25%): 7 | Under-commented (<10%): 6

---

## Feature 2: ES Modules

### Completed Changes

1. **Converted all 16 source files** to ES module syntax:
   - `constants.js`, `utils.js`, `lexer.js`, `scanner.js`, `parser.js`
   - `runtime.js`, `interpreter.js`
   - `ast-renderer.js`, `parser-renderer.js`, `output-renderer.js`, `memory-renderer.js`
   - `visualizer.js`, `modal.js`, `examples.js`, `main.js`

2. **Converted all 29 example files**:
   - Changed from `window.EXAMPLES['name'] = {...}` to `export const example = {...}`
   - Examples are now aggregated in `examples.js` via imports

3. **Updated HTML**:
   - `index.html`: Single entry point `<script type="module" src="src/main.js">`
   - `language-help.html`: Inlined COLORS for standalone use (can't import modules)

4. **Fixed issues discovered during migration**:
   - Added missing `COLORS` import to `output-renderer.js`
   - Fixed 12 example files with syntax errors (extra `)` after template literals)

### Benefits Achieved

- **Explicit dependencies** - Each file declares what it imports
- **No global pollution** - Removed all `window.X` patterns
- **Better tooling** - IDEs can track imports/exports
- **Modern standard** - Native browser ES modules

---

## Code Quality Analysis

### Strengths

- **Clean separation of concerns**: Lexer → Parser → Interpreter pipeline
- **Consistent patterns**: All renderers follow same constructor/render pattern
- **Naming conventions**: camelCase functions, PascalCase classes throughout
- **No circular dependencies**: Healthy module graph
- **Custom error classes**: `RuntimeError` with line/column info

### Issues Found

#### Dead Code
| File | Line | Issue |
|------|------|-------|
| `reference.js` | 1-151 | Entire file unused - not imported anywhere |
| `memory-renderer.js` | 128-152 | `renderLegacy()` method never called |

#### Potential Bugs
| File | Line | Issue |
|------|------|-------|
| `lexer.js` | 172-179 | Invalid char error → recursive `nextToken()` call risks infinite loop |
| `parser.js` | 86-88 | `getTitle()` doesn't guard against null token |
| `output-renderer.js` | 140-154 | `keydown` listener may not be removed on error paths |

#### Code Smells
| File | Line | Issue |
|------|------|-------|
| `interpreter.js` | - | 617 lines - consider splitting |
| `parser.js` | - | 596 lines - consider splitting |
| `scanner.js` | 276-277 | Mutates token value after adding to array |
| `lexer.js` | 223-227, 371-374 | `peekNext()` defined twice |

#### Inconsistencies
| File | Issue |
|------|-------|
| `reference.js` | Has CommonJS export alongside ES modules |
| `lexer.js` | `readString()` returns null on error vs token object |

### Summary

| Category | Count |
|----------|-------|
| Dead code | 2 |
| Potential bugs | 3 |
| Code smells | 4 |
| Inconsistencies | 2 |

**Recommendation**: Address dead code and potential bugs in a future release. The large file sizes are acceptable for now but could be split if they grow further.
