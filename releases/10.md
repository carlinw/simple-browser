# Release 10: While Loops

> Follow CLAUDE.md - do not implement until user approves complete release plan.

## Code Quality Analysis

**Current codebase:** 5,557 lines across 28 files (14 src, 11 tests, 3 css, 1 html)
**Tests:** 157 passing

### File Size Review

| File | Lines | Status |
|------|-------|--------|
| interpreter.css | 524 | MONITOR - approaching 600 threshold |
| lexer.js | 390 | OK |
| scanner.js | 384 | OK |
| parser.js | 381 | OK |
| main.js | 335 | OK |

### Issues to Address

No critical issues. Codebase is healthy.

| Priority | Issue | Action |
|----------|-------|--------|
| **MONITOR** | interpreter.css at 524 lines | Consider splitting if grows past 600 |

---

## Goals

Implement while loop execution in the interpreter. The parser already handles while loops - we just need to interpret them.

## Current State

- Parser handles while loop syntax (creates WhileStatement AST nodes)
- Interpreter throws "While loops not yet supported (coming in Release 10)" error
- If/else conditionals work (Release 9)
- Code highlighting during execution works (Release 9)

---

## Language Syntax (this release)

### While Loop

```
while (condition) {
  // body - executes repeatedly while condition is truthy
}
```

**Semantics:**
1. Evaluate condition
2. If truthy, execute body, then go back to step 1
3. If falsy, exit the loop

**Example:**
```
let i = 0
while (i < 5) {
  print i
  i = i + 1
}
// Output: 0, 1, 2, 3, 4
```

---

## Interpreter Implementation

### WhileStatement Case

Replace the error-throwing stub with actual execution:

```javascript
case 'WhileStatement': {
  while (this.isTruthy(await this.evaluate(node.condition))) {
    result = await this.execute(node.body);
  }
  break;
}
```

### Infinite Loop Protection

To prevent the browser from freezing on infinite loops, add a maximum iteration limit:

```javascript
case 'WhileStatement': {
  const MAX_ITERATIONS = 10000;
  let iterations = 0;

  while (this.isTruthy(await this.evaluate(node.condition))) {
    if (++iterations > MAX_ITERATIONS) {
      throw new RuntimeError(`Infinite loop detected (exceeded ${MAX_ITERATIONS} iterations)`);
    }
    result = await this.execute(node.body);
  }
  break;
}
```

This protects users from accidentally freezing their browser while still allowing reasonable loops.

---

## Tests

### While Loop Tests (tests/while-loops.spec.js)

1. **"while loop executes body while condition is true"**
   - Run: `let i = 0\nwhile (i < 3) { print i\ni = i + 1 }`
   - Output: `0`, `1`, `2`

2. **"while loop with false condition never executes"**
   - Run: `while (false) { print "never" }`
   - Output: (empty)

3. **"while loop modifies variables"**
   - Run: `let sum = 0\nlet i = 1\nwhile (i <= 5) { sum = sum + i\ni = i + 1 }\nprint sum`
   - Output: `15`

4. **"while loop with comparison condition"**
   - Run: `let x = 10\nwhile (x > 0) { x = x - 3 }\nprint x`
   - Output: `-2` (or `1` depending on last iteration)

5. **"nested while loops"**
   - Run: `let i = 0\nlet count = 0\nwhile (i < 2) { let j = 0\nwhile (j < 2) { count = count + 1\nj = j + 1 }\ni = i + 1 }\nprint count`
   - Output: `4`

6. **"while loop with variable condition"**
   - Run: `let running = true\nlet i = 0\nwhile (running) { i = i + 1\nif (i == 3) { running = false } }\nprint i`
   - Output: `3`

7. **"infinite loop protection"**
   - Run: `while (true) { }`
   - Error: `Infinite loop detected`

8. **"while loop highlights during animated execution"**
   - Run animated: `let i = 0\nwhile (i < 2) { i = i + 1 }`
   - Verify: code highlighting moves through condition and body each iteration

---

## File Changes

```
src/
  interpreter.js     # Add WhileStatement case with infinite loop protection
tests/
  while-loops.spec.js    # NEW - 8 tests for while loops
```

---

## Deliverables

- [ ] Replace WhileStatement error stub with actual execution
- [ ] Add infinite loop protection (MAX_ITERATIONS = 10000)
- [ ] Create tests/while-loops.spec.js with 8 tests
- [ ] All tests passing (165+ total)

---

## Example Programs

After this release, users can write:

**Countdown:**
```
let n = 5
while (n > 0) {
  print n
  n = n - 1
}
print "Liftoff!"
```

**Fibonacci:**
```
let a = 0
let b = 1
let i = 0
while (i < 10) {
  print a
  let temp = a + b
  a = b
  b = temp
  i = i + 1
}
```

**Sum of numbers:**
```
let sum = 0
let i = 1
while (i <= 100) {
  sum = sum + i
  i = i + 1
}
print sum
```

---

## Status

**COMPLETE** - 165 tests passing

### Completed Deliverables

- [x] Replace WhileStatement error stub with actual execution
- [x] Add infinite loop protection (MAX_ITERATIONS = 10000)
- [x] Create tests/while-loops.spec.js with 8 tests
- [x] Fix runFast to use onPrint callback (consistent with runAnimated)
- [x] Update interpreter tests to use print statements
- [x] All tests passing (165 total)
